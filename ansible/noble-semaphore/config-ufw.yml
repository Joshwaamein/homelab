---
- name: Configure UFW firewall rules for all hosts
  hosts: ubuntu_vms, evernode, xahau, unifi, nginx, servarr, pi4, pve_data, presearch, myst, ubuntu_docker, discord_bot, pihole, ansible
  become: yes
  gather_facts: true
  ignore_unreachable: true
  
  tasks:
    - name: Print hostname
      ansible.builtin.debug:
        msg: "Configuring UFW on {{ ansible_hostname }}"

    - name: Ensure UFW is installed (Debian/Ubuntu)
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Ensure UFW is installed (RedHat/Alma)
      ansible.builtin.yum:
        name: ufw
        state: present
      when: ansible_os_family == "RedHat"

    - name: Configure UFW for non-Proxmox hosts
      block:
        - name: Check current UFW status
          ansible.builtin.command: ufw status
          register: ufw_status
          changed_when: false
          failed_when: false

        - name: CRITICAL - Ensure SSH is allowed BEFORE enabling UFW
          community.general.ufw:
            rule: allow
            port: '22'
            proto: tcp
            comment: 'SSH - CRITICAL for remote access'
          register: ssh_rule

        - name: Verify SSH rule was added
          ansible.builtin.assert:
            that:
              - ssh_rule is succeeded
            fail_msg: "CRITICAL: Failed to add SSH rule. Aborting to prevent lockout!"
            success_msg: "SSH rule confirmed - safe to proceed"

        - name: Set UFW default policies
          community.general.ufw:
            direction: "{{ item.direction }}"
            policy: "{{ item.policy }}"
          loop:
            - { direction: 'incoming', policy: 'deny' }
            - { direction: 'outgoing', policy: 'allow' }
            - { direction: 'routed', policy: 'deny' }

        - name: Apply base firewall rules (SSH, Zabbix, Tailscale)
          community.general.ufw:
            rule: allow
            port: "{{ item.port }}"
            proto: "{{ item.proto | default('tcp') }}"
            comment: "{{ item.comment }}"
          loop:
            - { port: '22', proto: 'tcp', comment: 'SSH' }
            - { port: '10050', proto: 'tcp', comment: 'Zabbix Agent' }
            - { port: '39098', proto: 'udp', comment: 'Tailscale' }
            - { port: '44840', proto: 'udp', comment: 'Tailscale DERP' }

        - name: Configure Evernode rules
          community.general.ufw:
            rule: allow
            port: "{{ item.port }}"
            proto: "{{ item.proto }}"
            comment: "Evernode - {{ item.comment }}"
          loop:
            - { port: '80', proto: 'tcp', comment: 'HTTP' }
            - { port: '443', proto: 'tcp', comment: 'HTTPS' }
            - { port: '26201', proto: 'tcp', comment: 'XRPL WS' }
            - { port: '26202', proto: 'tcp', comment: 'XRPL WS Public' }
            - { port: '26203', proto: 'tcp', comment: 'Hook API' }
            - { port: '26204', proto: 'tcp', comment: 'Sashimono WS' }
            - { port: '36525-36531', proto: 'tcp', comment: 'Contract ports' }
            - { port: '39064-39070', proto: 'udp', comment: 'Contract UDP' }
            - { port: '22861-22864', proto: 'tcp', comment: 'Additional contracts' }
          when: "'evernode' in group_names"

        - name: Configure UniFi rules
          community.general.ufw:
            rule: allow
            from_ip: "{{ item.src }}"
            to_port: "{{ item.port }}"
            proto: "{{ item.proto }}"
            comment: "UniFi - {{ item.comment }}"
          loop:
            - { src: '100.0.0.0/8', port: '8080', proto: 'tcp', comment: 'Device inform' }
            - { src: '100.0.0.0/8', port: '8443', proto: 'tcp', comment: 'Web UI' }
            - { src: '100.0.0.0/8', port: '3478', proto: 'udp', comment: 'STUN' }
            - { src: '100.0.0.0/8', port: '10001', proto: 'udp', comment: 'Discovery' }
            - { src: '100.0.0.0/8', port: '1900', proto: 'udp', comment: 'L2 Discovery' }
            - { src: '192.168.0.0/16', port: '8080', proto: 'tcp', comment: 'Device inform local' }
            - { src: '192.168.0.0/16', port: '8443', proto: 'tcp', comment: 'Web UI local' }
            - { src: '192.168.0.0/16', port: '3478', proto: 'udp', comment: 'STUN local' }
            - { src: '192.168.0.0/16', port: '10001', proto: 'udp', comment: 'Discovery local' }
            - { src: '192.168.0.0/16', port: '1900', proto: 'udp', comment: 'L2 Discovery local' }
          when: "'unifi' in group_names"

        - name: Configure Pi-hole rules
          community.general.ufw:
            rule: allow
            port: "{{ item.port }}"
            proto: "{{ item.proto | default('tcp') }}"
            comment: "Pi-hole - {{ item.comment }}"
          loop:
            - { port: '53', proto: 'tcp', comment: 'DNS TCP' }
            - { port: '53', proto: 'udp', comment: 'DNS UDP' }
            - { port: '67', proto: 'udp', comment: 'DHCP' }
            - { port: '547', proto: 'udp', comment: 'DHCPv6' }
            - { port: '80', proto: 'tcp', comment: 'Web Interface' }
            - { port: '443', proto: 'tcp', comment: 'Web Interface HTTPS' }
          when: "'pihole' in group_names"

        - name: Configure Servarrr rules
          community.general.ufw:
            rule: "{{ item.rule | default('allow') }}"
            port: "{{ item.port }}"
            proto: "{{ item.proto | default('tcp') }}"
            comment: "Servarrr - {{ item.comment }}"
          loop:
            - { port: '8080', comment: 'SABnzbd' }
            - { port: '8787', comment: 'Readarr' }
            - { port: '8191', comment: 'FlareSolverr' }
            - { port: '6767', comment: 'Bazarr' }
            - { port: '9982', comment: 'TVHeadend' }
            - { port: '8686', comment: 'Lidarr' }
            - { port: '9000', comment: 'Portainer' }
            - { port: '8096', comment: 'Jellyfin' }
            - { port: '7878', comment: 'Radarr' }
            - { port: '8989', comment: 'Sonarr' }
            - { port: '9696', comment: 'Prowlarr' }
            - { port: '9981', comment: 'TVHeadend streams' }
            - { port: '8388', comment: 'Overseerr' }
            - { port: '8888', comment: 'Requestrr' }
            - { port: '9117', comment: 'Jackett' }
            - { port: '137', proto: 'udp', rule: 'deny', comment: 'Block NetBIOS' }
            - { port: '138', proto: 'udp', rule: 'deny', comment: 'Block NetBIOS' }
            - { port: '139', rule: 'deny', comment: 'Block SMB' }
            - { port: '445', rule: 'deny', comment: 'Block SMB' }
          when: "'servarr' in group_names or 'servarrr' in group_names"

        - name: Configure Ansible host rules
          community.general.ufw:
            rule: allow
            port: "{{ item }}"
            comment: "Ansible - Management"
          loop:
            - '3000'
          when: "'ansible' in group_names"

        - name: Configure pve_data rules
          community.general.ufw:
            rule: allow
            port: "{{ item.port }}"
            comment: "Data services - {{ item.comment }}"
          loop:
            - { port: '3000', comment: 'Grafana' }
            - { port: '8086', comment: 'InfluxDB' }
            - { port: '5432', comment: 'PostgreSQL' }
          when: "'pve_data' in group_names"

        - name: Configure Xahau rules
          community.general.ufw:
            rule: allow
            port: "{{ item }}"
            comment: "Xahau"
          loop:
            - '80'
            - '443'
            - '21337'
          when: "'xahau' in group_names"

        - name: Configure Pi4 rules
          community.general.ufw:
            rule: allow
            port: '5000'
            comment: "Pi4 services"
          when: "'pi4' in group_names"

        - name: Configure ubuntu_docker rules
          community.general.ufw:
            rule: allow
            port: "{{ item }}"
            comment: "Docker services"
          loop:
            - '9000'
            - '9443'
            - '8080'
            - '8082'
          when: "'ubuntu_docker' in group_names"

        - name: Enable UFW with confirmation
          community.general.ufw:
            state: enabled
          register: ufw_enabled

        - name: Verify UFW is active
          ansible.builtin.command: ufw status verbose
          register: ufw_final_status
          changed_when: false

        - name: Display final UFW status
          ansible.builtin.debug:
            var: ufw_final_status.stdout_lines

      rescue:
        - name: EMERGENCY - Disable UFW on error
          community.general.ufw:
            state: disabled
          ignore_errors: yes

        - name: Alert about UFW failure
          ansible.builtin.fail:
            msg: "UFW configuration failed! Firewall has been disabled to prevent lockout."

      when: 
        - "'proxmox' not in group_names"
        - "'pbs' not in group_names"