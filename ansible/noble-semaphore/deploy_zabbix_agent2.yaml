---
- name: Upgrade zabbix-agent to zabbix-agent2
  hosts: ubuntu_vms, pbs, hosts
  become: true
  gather_facts: true
  ignore_unreachable: true

  tasks:
    - name: Print hostname
      ansible.builtin.debug:
        msg: "Configuring Zabbix Agent 2 on {{ ansible_hostname }}"

    - name: Stop old zabbix-agent (if exists)
      ansible.builtin.systemd:
        name: zabbix-agent
        state: stopped
        enabled: false
      failed_when: false
      when: ansible_os_family == "Debian"

    - name: Add Zabbix repository
      ansible.builtin.get_url:
        url: "https://repo.zabbix.com/zabbix/{{ zabbix_version }}/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_{{ zabbix_version }}+ubuntu{{ ansible_distribution_version }}_all.deb"
        dest: /tmp/zabbix-release.deb
        mode: '0644'
      register: download_repo
      when: ansible_os_family == "Debian"

    - name: Install Zabbix repository package
      ansible.builtin.apt:
        deb: /tmp/zabbix-release.deb
        state: present
      when: ansible_os_family == "Debian" and download_repo.changed

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install zabbix-agent2
      ansible.builtin.apt:
        name: zabbix-agent2
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Deploy zabbix_agent2 configuration from template
      ansible.builtin.template:
        src: templates/zabbix_agent2.conf.j2
        dest: /etc/zabbix/zabbix_agent2.conf
        owner: zabbix
        group: zabbix
        mode: '0644'
        backup: yes
      when: ansible_os_family == "Debian"
      notify: Restart zabbix-agent2

    - name: Ensure zabbix-agent2 is enabled and started
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: started
        enabled: true
      when: ansible_os_family == "Debian"

    - name: Get Tailscale IP addresses
      ansible.builtin.set_fact:
        tailscale_ips: "{{ ansible_all_ipv4_addresses | select('match', '^100\\.') | list }}"

    - name: Print Tailscale IPs found
      ansible.builtin.debug:
        msg: "Tailscale IPs: {{ tailscale_ips }}"
      when: tailscale_ips | length > 0

    - name: Update Zabbix server host configuration
      community.zabbix.zabbix_host:
        server_url: "http://{{ zabbix_server_ip }}"
        login_user: "{{ zabbix_admin_user }}"
        login_password: "{{ zabbix_admin_password }}"
        host_name: "{{ ansible_hostname }}"
        host_groups:
          - Linux servers
        link_templates:
          - "Linux by Zabbix agent active"
        interfaces:
          - type: 1
            main: 1
            ip: "{{ tailscale_ips[0] }}"
            port: 10050
      when: 
        - tailscale_ips | length > 0
        - zabbix_admin_user is defined
        - zabbix_admin_password is defined
      delegate_to: localhost
      run_once: false

    - name: Print completion message
      ansible.builtin.debug:
        msg: "Zabbix Agent 2 installed and configured on {{ ansible_hostname }}"

  handlers:
    - name: Restart zabbix-agent2
      ansible.builtin.systemd:
        name: zabbix-agent2
        state: restarted
        enabled: true