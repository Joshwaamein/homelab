---
# Safe reboot playbook with proper ordering to prevent infrastructure issues
# Order: VMs first (EXCLUDING ansible control node), then Proxmox hosts serially
#
# IMPORTANT: The ansible/semaphore control node is NOT rebooted by this playbook.
# Configure unattended-upgrades on the ansible server to handle its reboots independently.
#
# NOTE: Rebooting pve2 (where ansible VM is hosted) is SAFE because:
# - The reboot command is sent BEFORE pve2 actually reboots
# - Ansible waits for reboot completion, but the command is already queued
# - The ansible VM will come back up when pve2 restarts

- name: Update and reboot VMs (First - VMs don't affect each other)
  hosts: ubuntu_vms, pbs
  gather_facts: true
  become: true
  ignore_unreachable: true
  serial: 5  # Reboot 5 VMs at a time to avoid overwhelming network/hosts
  tags: update,upgrade,reboot,vms

  tasks:
    - name: Print hostname
      debug:
        msg: "Hostname is {{ ansible_hostname | default(inventory_hostname) }}"

    - name: Skip if this is the ansible control node
      meta: end_host
      when: inventory_hostname == 'localhost' or inventory_hostname == '127.0.0.1'

    - name: Notify if host facts are missing
      debug:
        msg: "Skipping host {{ inventory_hostname }} because facts are unavailable"
      when: ansible_os_family is not defined

    - name: Skip non-Debian/Ubuntu hosts
      meta: end_host
      when: ansible_os_family is not defined or ansible_os_family != "Debian"

    - name: Update apt repo and cache
      apt:
        update_cache: yes
        force_apt_get: yes
        cache_valid_time: 3600
      tags: update

    - name: Upgrade all packages (safe upgrade)
      apt:
        upgrade: safe
        force_apt_get: yes
      tags: upgrade

    - name: Check if a reboot is needed
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags: reboot

    - name: Reboot VM if system requires it
      reboot:
        msg: "Reboot initiated by Ansible due to system updates requiring restart"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists
      tags: reboot

    - name: Print summary
      debug:
        msg: "{{ inventory_hostname }} - Updates complete{{ ', rebooted' if reboot_required_file.stat.exists else ', no reboot needed' }}"

- name: Update and reboot Proxmox hosts (Last - SERIAL to prevent all hosts going down)
  hosts: hosts
  gather_facts: true
  become: true
  ignore_unreachable: true
  serial: 1  # CRITICAL: Only reboot ONE Proxmox host at a time
  tags: update,upgrade,reboot,hosts

  tasks:
    - name: Print hostname
      debug:
        msg: "=== PROXMOX HOST: {{ ansible_hostname | default(inventory_hostname) }} ==="

    - name: Skip if this is the ansible control node
      meta: end_host
      when: inventory_hostname == 'localhost' or inventory_hostname == '127.0.0.1'

    - name: Notify if host facts are missing
      debug:
        msg: "Skipping host {{ inventory_hostname }} because facts are unavailable"
      when: ansible_os_family is not defined

    - name: Skip non-Debian/Ubuntu hosts
      meta: end_host
      when: ansible_os_family is not defined or ansible_os_family != "Debian"

    - name: Update apt repo and cache
      apt:
        update_cache: yes
        force_apt_get: yes
        cache_valid_time: 3600
      tags: update

    - name: Upgrade all packages (safe upgrade)
      apt:
        upgrade: safe
        force_apt_get: yes
      tags: upgrade

    - name: Check if a reboot is needed
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      tags: reboot

    - name: WARNING - About to reboot Proxmox host
      debug:
        msg: "WARNING: About to reboot Proxmox host {{ inventory_hostname }}. All VMs will restart."
      when: reboot_required_file.stat.exists

    - name: Reboot Proxmox host if system requires it
      reboot:
        msg: "Reboot initiated by Ansible due to system updates requiring restart"
        connect_timeout: 5
        reboot_timeout: 600  # Longer timeout for hosts (10 minutes)
        pre_reboot_delay: 10  # 10 second delay before reboot
        post_reboot_delay: 60  # Wait 60 seconds after reboot for VMs to stabilize
        test_command: uptime
      when: reboot_required_file.stat.exists
      tags: reboot

    - name: Wait for Proxmox services to fully start
      wait_for:
        timeout: 30
      delegate_to: localhost
      when: reboot_required_file.stat.exists

    - name: Print summary
      debug:
        msg: "{{ inventory_hostname }} - Updates complete{{ ', rebooted' if reboot_required_file.stat.exists else ', no reboot needed' }}"

- name: Final summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Reboot process complete
      debug:
        msg: |
          ========================================
          Reboot process complete!
          - VMs were rebooted first (in batches)
          - Proxmox hosts rebooted one at a time
          - Ansible control node was NOT rebooted
          ========================================