---
- name: Secure SSH configuration with safety checks
  hosts: ubuntu_vms, pbs, hosts, noble_net_alma
  become: true
  gather_facts: true
  ignore_unreachable: true
  
  tasks:
    - name: Print hostname
      ansible.builtin.debug:
        msg: "Securing SSH on {{ ansible_hostname }}"

    - name: Backup current sshd_config
      ansible.builtin.copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup.{{ ansible_date_time.epoch }}
        remote_src: yes
        mode: '0600'
      changed_when: false

    - name: Check if authorized_keys file exists for current user
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.ssh/authorized_keys"
      register: authorized_keys_file
      when: ansible_env.HOME is defined

    - name: Check if authorized_keys exists for root
      ansible.builtin.stat:
        path: /root/.ssh/authorized_keys
      register: root_authorized_keys

    - name: Verify at least one user has SSH keys configured
      ansible.builtin.assert:
        that:
          - authorized_keys_file.stat.exists | default(false) or root_authorized_keys.stat.exists
        fail_msg: |
          CRITICAL: No SSH keys found! 
          Cannot disable password authentication without SSH keys.
          Please add SSH keys first using: ssh-copy-id user@host
        success_msg: "SSH keys verified - safe to disable password authentication"
      when: ssh_password_authentication == false

    - name: Configure PermitRootLogin
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*PermitRootLogin'
        line: 'PermitRootLogin {{ ssh_permit_root_login }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Configure PasswordAuthentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*PasswordAuthentication'
        line: 'PasswordAuthentication {{ "yes" if ssh_password_authentication else "no" }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh
      when: ssh_password_authentication is defined

    - name: Ensure PubkeyAuthentication is enabled
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Disable empty passwords
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*PermitEmptyPasswords'
        line: 'PermitEmptyPasswords {{ "yes" if ssh_permit_empty_passwords else "no" }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Configure X11 Forwarding
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*X11Forwarding'
        line: 'X11Forwarding {{ "yes" if ssh_x11_forwarding else "no" }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Configure ClientAliveInterval
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*ClientAliveInterval'
        line: 'ClientAliveInterval {{ ssh_client_alive_interval }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Configure ClientAliveCountMax
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?\s*ClientAliveCountMax'
        line: 'ClientAliveCountMax {{ ssh_client_alive_count_max }}'
        state: present
        backup: yes
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart ssh

    - name: Test SSH configuration syntax
      ansible.builtin.command: /usr/sbin/sshd -t
      changed_when: false
      register: sshd_test

    - name: Display SSH configuration summary
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════════"
          - "SSH Hardening Configuration Applied:"
          - "  Host: {{ ansible_hostname }}"
          - "  Root Login: {{ ssh_permit_root_login }}"
          - "  Password Auth: {{ ssh_password_authentication }}"
          - "  Empty Passwords: {{ ssh_permit_empty_passwords }}"
          - "  Pubkey Auth: yes"
          - "  X11 Forwarding: {{ ssh_x11_forwarding }}"
          - "  ClientAliveInterval: {{ ssh_client_alive_interval }}s"
          - "  ClientAliveCountMax: {{ ssh_client_alive_count_max }}"
          - "═══════════════════════════════════════════"

    - name: Verify SSH connection test
      ansible.builtin.command: "echo 'SSH connection verified'"
      changed_when: false
      register: ssh_verify

    - name: Print SSH configuration status
      ansible.builtin.debug:
        msg: "✓ SSH configuration updated and verified successfully on {{ ansible_hostname }}"

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: "{{ 'ssh' if ansible_os_family == 'Debian' else 'sshd' }}"
        state: restarted
      ignore_errors: true
