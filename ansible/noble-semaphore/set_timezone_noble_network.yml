---
- name: Configure timezone to Europe/London on Noble Network Linux servers (ignoring unreachable/non-systemd hosts)
  # Target groups that are expected to be Linux and use systemd
  hosts: ubuntu_vms, noble_net_alma, hosts, pbs
  gather_facts: true # Ensure Ansible gathers facts like ansible_service_mgr and ansible_os_family
  become: true       # Required to make system-level changes
  ignore_unreachable: true # This makes the play continue even if hosts are initially unreachable

  tasks:
    - name: Set timezone using community.general.timezone module
      community.general.timezone:
        name: "{{ timezone }}"
      # Corrected 'when' condition: Check if 'ansible_service_mgr' is defined BEFORE comparing its value.
      # This prevents failure on hosts where facts couldn't be gathered.
      when: ansible_service_mgr is defined and ansible_service_mgr == 'systemd'
      notify: Restart relevant services
      register: timezone_result

    - name: Display timezone configuration
      ansible.builtin.debug:
        msg: "✓ Timezone set to {{ timezone }} on {{ ansible_hostname }}"
      when: ansible_service_mgr is defined and ansible_service_mgr == 'systemd'

    - name: Verify timezone was set correctly
      ansible.builtin.command: timedatectl show --property=Timezone --value
      register: current_tz
      changed_when: false
      when: ansible_service_mgr is defined and ansible_service_mgr == 'systemd'

    - name: Display comprehensive summary
      ansible.builtin.debug:
        msg:
          - "═══════════════════════════════════════════"
          - "Timezone Configuration Complete"
          - "Host: {{ ansible_hostname }}"
          - "Expected Timezone: {{ timezone }}"
          - "Current Timezone: {{ current_tz.stdout | default('Not verified') }}"
          - "Status: {{ 'Changed' if timezone_result is changed else 'Already set' }}"
          - "═══════════════════════════════════════════"
      when: current_tz is defined

  handlers:
    # Handler for Debian/Ubuntu systems
    - name: Restart cron service (Debian/Ubuntu)
      listen: Restart relevant services
      ansible.builtin.service:
        name: cron
        state: restarted
      # Robust 'when' condition for handlers as well
      when: ansible_os_family is defined and ansible_os_family == 'Debian'

    # Handler for RedHat/AlmaLinux systems
    - name: Restart crond service (RedHat/AlmaLinux)
      listen: Restart relevant services
      ansible.builtin.service:
        name: crond
        state: restarted
      # Robust 'when' condition for handlers as well
      when: ansible_os_family is defined and ansible_os_family == 'RedHat'